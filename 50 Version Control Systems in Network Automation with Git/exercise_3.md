## Problem Statement:
### GitLab Integration with Ansible Tower
Let's utilize Ansible Tower to execute all the tasks we completed in the previous exercise and initiate the playbook through Ansible Tower.

## Steps

- **First login to Ansible Tower**: Details of the Tower can be found in the first lab.
![alt text](image-35.png)

#### Creation of GitLab Credentials in AAP:

   - Navigate to the "Credentials" section in AAP.  
    ![alt text](image-37.png)
   
   - Click on "Add Credentials" and select "Source control" as the credential type.  
    ![alt text](image-36.png)
   
   - Provide the required GitLab credentials (username and password).
   - Save the credential configuration.
   ![alt text](image-38.png)

   - GitLab credentials are configured within AAP, allowing seamless access to the GitLab repository.

#### Inventory Creation in Ansible Automation Platform (AAP):
- Navigate to the "Inventory" section under Resources.

    ![alt text](image-39.png)

- Click on "Add" and enter "eve_inventory" as the name and select the organization as default.
    in the variables please fill the below text.
    ```yaml
    ansible_connection: ansible.netcommon.network_cli
    ```

  ![alt text](image-63.png)

- Next, add a host "vyos1-site2" to the inventory.
  - Go to hosts in eve_inventory  
  ![alt text](image-40.png)
  - Click on add and fill in the below details  
  ```yaml
    ---
    ansible_host: 172.16.14.215
    ansible_network_os: vyos
  ```
  ![alt text](image-41.png)
  - Click on save
  - Let's add one more host, go to hosts again.

  ![alt text](image-42.png)
  - Click on add and fill in the below details

- Next, add a host "vyos2-site2" to the inventory.
  ```yaml
    ---
    ansible_host: 172.16.14.216
    ansible_network_os: vyos
  ```
  ![alt text](image-43.png)
- Click on save, and now you can see we have 2 devices in our inventory.  
![alt text](image-44.png)

#### Now let's create credentials for these routers that we are going to use in our inventory.
 - Click on "Add Credentials" and select "machine" as the credential type.

 ![alt text](image-45.png)
 ![alt text](image-46.png)
- Fill in the details as per your need.
![alt text](image-47.png)
- Click on save.

#### Now Create custom creds that are going to be used for cloning the repo and also pushing the code into that repo.
- Go to the credential type.

![alt text](image-51.png)
- Click on add.
- Fill the details like name *Gitlab Creds*
    - Input configurations
    ```yaml
    fields:
      - id: gitlab_username
        type: string
        label: Gitlab user
        secret: false
      - id: gitlab_password
        type: string
        label: Gitlab Password
        secret: true
    required:
      - gitlab_username
      - gitlab_password
    ```
    - Injector configurations
    ```yaml
    extra_vars:
      gitlab_password: '{{ gitlab_password }}'
      gitlab_username: '{{ gitlab_username }}'
    ```
    ![alt text](image-50.png)


- Now go to credentials and create a new credential with the type (Gitlab Creds) 
- Click on add and fill in the details
![alt text](image-52.png)
- Click on save.

#### Now our required steps are completed. Let's go to GitLab and commit our playbook in the GitLab repository. 
- Now go to GitLab and create the project (my project name is gitlab-ansible-tower), feel free to change it.
![alt text](image-33.png)

- Open the repo in the web IDE.
![alt text](image-34.png)


- Create the files that we created in the last lab (playbook.yaml) with the below content.

![alt text](image-48.png)

```yaml
---
- name: Fetch show version from devices in dc_group
  hosts: vyos1-site2,vyos2-site2
  gather_facts: no

  tasks:
    - name: Clone the GitLab repository
      delegate_to: localhost
      run_once: true
      ansible.builtin.expect:
        command: git clone http://172.16.14.202/ansible/backup_configurations.git --verbose
        responses:
          (?i)Username: "{{ gitlab_username }}"
          (?i)Password: "{{ gitlab_password }}"
    
    - name: Run show version command
      register: show_version_output
      vyos_command:
        commands:
          - show version
          - show interfaces

    - name: Get current date and time
      set_fact:
        current_datetime: "{{ '%Y-%m-%d %H:%M:%S' | strftime }}"
    
    - name: Save show version output to file
      ansible.builtin.copy:
        content: "# This code is dynamically generated by Ansible {{ current_datetime }}\n{{ show_version_output.stdout[0] | replace('\\n','\n')}}"
        dest: "./backup_configurations/{{ inventory_hostname }}_show_version.cfg"
    
    - name: Save show version output to file
      ansible.builtin.copy:
        content: "# This code is dynamically generated by Ansible {{ current_datetime }}\n{{ show_version_output.stdout[1] | replace('\\n','\n')}}"
        dest: "./backup_configurations/{{ inventory_hostname }}_show_interfaces.cfg"

    - name: commit the code
      delegate_to: localhost
      run_once: true
      with_items:
        - "git add ."
        - git config --global user.name "user1"
        - git config --global user.email "user1@onemindservices.com"
        - "git commit -m 'configurations update'"
        - git push origin master
      ansible.builtin.expect:
        chdir: "./backup_configurations"
        command: "{{ item }}"
        responses:
          (?i)Username: "{{ gitlab_username }}"
          (?i)Password: "{{ gitlab_password }}"

```
- Click on *commit...*.  
![alt text](image-53.png)

- Click on commit to the master branch.

![alt text](image-54.png)


#### Now we have placed our project in GitLab. Let's go to Ansible Tower and create a project in it.

### 5. Project Creation with GitLab as Source Control:

  - Navigate to the "Projects" section in AAP.

![alt text](image-55.png)

  - Click on "add" and specify config-backup as the name.

  - Choose Git as the source control type and add the source control URL and branch.
  - Link the project to the previously configured GitLab credentials.
  - Save the project configuration.

  ![alt text](image-56.png)

  - A project is created within AAP, utilizing GitLab

 as the source control system for storing and managing automation scripts.

### 6. Template Creation and Scheduled Execution:
  - Go to the template.

  ![alt text](image-57.png)
  - Click on *add job template*.

![alt text](image-59.png)

  - Create a template with "router-backup-conf" as the name.
  - Select eve-inventory and backup-config for inventory and the project.
  - Select playbook.yaml as the playbook.
  - Link the previously configured credentials (select routers_creds, gitlab user details).
  - Click create template.
![alt text](image-60.png)

  ![image](https://github.com/Onemind-Services-LLC/naf/assets/132569101/5ae74808-a621-4a74-abbf-b776c7f641e1)

  - Schedule the playbook as shown below.

  ![image](https://github.com/Onemind-Services-LLC/naf/assets/132569101/23ecf6c9-016f-465a-92bc-261807443db6)

  - An Ansible template is developed within the AAP project, automating lab infrastructure setup and configuration.

### 7. Template Execution:
  - Go to the templates list.
  - Select the template that you just created.
  - Click on launch.
 ![alt text](image-61.png)

- Now you can go and check in GitLab your configurations files updated.
![alt text](image-62.png)

In this lab, we successfully automated the process of backing up configurations and integrating Ansible with Git for version control using GitLab.

**Currently, we're executing the "show version" and "show ip interface" commands, storing their outputs in GitLab. Additionally, we can back up the router configuration to GitLab as well.**